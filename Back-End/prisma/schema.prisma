// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"       // Troque para "postgresql" em produção
  url      = env("DATABASE_URL")
}

// ─── User ─────────────────────────────────────────────────────────────────────

model User {
  id           String   @id @default(cuid())
  name         String
  lastName     String
  email        String   @unique
  passwordHash String
  plan         String   @default("starter")
  apiKeys      String   @default("{}")   // JSON serializado

  bots          Bot[]
  conversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Bot ──────────────────────────────────────────────────────────────────────

model Bot {
  id           String  @id @default(cuid())
  userId       String
  name         String
  model        String
  prompt       String
  isActive     Boolean @default(false)
  isConnected  Boolean @default(false)
  phone        String?
  sessionName  String  @unique
  messageCount Int     @default(0)

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations Conversation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Conversation ─────────────────────────────────────────────────────────────

model Conversation {
  id           String   @id @default(cuid())
  botId        String
  userId       String
  contactName  String
  contactPhone String
  lastMessage  String
  lastMessageAt DateTime
  unreadCount  Int      @default(0)
  messageCount Int      @default(0)

  bot      Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)
  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages Message[]

  // ✅ Índice único para o upsert funcionar
  @@unique([botId, contactPhone])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ─── Message ──────────────────────────────────────────────────────────────────

model Message {
  id             String   @id @default(cuid())
  conversationId String
  role           String   // "user" | "assistant"
  content        String

  conversation Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
}
